<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BIRSUSPS DEMONLIST</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .collapsible { transition: max-height 300ms ease; overflow: hidden; }
  </style>
</head>
<body class="bg-zinc-900 text-zinc-100 font-sans min-h-screen">

<header class="text-center py-8">
  <div class="max-w-2xl mx-auto px-4 flex items-center justify-between">
    <div>
      <h1 class="text-4xl font-extrabold tracking-tight">BIRSUSPS DEMONLIST</h1>
      <p class="text-zinc-400 text-sm mt-1">The official demonlist for BirsusPS (2.2)</p>
    </div>
    <div class="flex gap-2">
      <button id="viewToggle" class="px-3 py-1 rounded bg-zinc-800 hover:bg-zinc-700 text-zinc-100 transition">
        View Leaderboard
      </button>
      <button id="loginBtn" class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-500 text-white transition">
        Login
      </button>
    </div>
  </div>
</header>

<div class="max-w-2xl mx-auto px-4 mb-6">
  <div class="flex gap-2">
    <input type="text" id="filterInput" placeholder="Filter by creator or rank..."
           class="flex-1 p-2 rounded bg-zinc-800 text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"/>
  </div>
</div>

<main id="list" class="max-w-2xl mx-auto px-4 pb-16 space-y-6">
  <p class="text-center text-zinc-500 animate-spin">⏳ Loading levels...</p>
</main>

<footer class="text-center text-zinc-600 text-xs pb-6">
  © 2025 BirsusPS Demonlist • Made by MartoGG
</footer>

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
  <div class="bg-zinc-800 p-6 rounded-2xl w-80">
    <h2 class="text-xl font-bold mb-4 text-zinc-100">Login</h2>
    <input type="text" id="username" placeholder="Username"
           class="w-full p-2 rounded mb-3 bg-zinc-700 text-zinc-100 focus:outline-none"/>
    <input type="password" id="password" placeholder="Password"
           class="w-full p-2 rounded mb-4 bg-zinc-700 text-zinc-100 focus:outline-none"/>
    <div class="flex justify-end gap-2">
      <button id="cancelLogin" class="px-3 py-1 rounded bg-zinc-600 hover:bg-zinc-500 text-zinc-100">Cancel</button>
      <button id="confirmLogin" class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-500 text-white">Login</button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
  <div class="bg-zinc-800 p-6 rounded-2xl w-96 max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-bold mb-4 text-zinc-100">Edit Level</h2>
    <form id="editForm" class="space-y-3">
      <input type="number" id="editRank" placeholder="Rank" class="w-full p-2 rounded bg-zinc-700 text-zinc-100"/>
      <input type="text" id="editTitle" placeholder="Title" class="w-full p-2 rounded bg-zinc-700 text-zinc-100"/>
      <input type="text" id="editCreator" placeholder="Creator" class="w-full p-2 rounded bg-zinc-700 text-zinc-100"/>
      <input type="text" id="editYoutube" placeholder="YouTube ID (optional)" class="w-full p-2 rounded bg-zinc-700 text-zinc-100"/>
      <textarea id="editRecords" placeholder="Record holders (name-percent-verified, comma-separated)" class="w-full p-2 rounded bg-zinc-700 text-zinc-100 h-24"></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" id="cancelEdit" class="px-3 py-1 rounded bg-zinc-600 hover:bg-zinc-500 text-zinc-100">Cancel</button>
        <button type="submit" class="px-3 py-1 rounded bg-green-600 hover:bg-green-500 text-white">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = "/api/levels";
let levels = [];
let isAdmin = false;
let editingIndex = null;

function pointercratePoints(rank){ return 150 * Math.pow(0.95, Math.max(0, rank-1)); }
function parsePercent(str){ if(!str) return 0; const m=String(str).trim().match(/^(\d+(\.\d+)?)\s*%?$/); return m?parseFloat(m[1]):0; }
function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

async function fetchLevels(){
  const res = await fetch(API);
  levels = await res.json();
  renderLevelsView(document.getElementById('list'), levels);
}

async function saveLevels(){
  await fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(levels)
  });
}

/* ---------- Render Levels ---------- */
function renderLevelsView(container, levelsArr){
  container.innerHTML='';
  levelsArr.sort((a,b)=>a.rank-b.rank);
  levelsArr.forEach((level,index)=>{
    const holdersHTML = level.recordHolders?.length
      ? level.recordHolders.map(h=>`${h.verified?`<span class="text-purple-400">${escapeHtml(h.name)}</span>`:escapeHtml(h.name)} - ${escapeHtml(h.percent)}${h.verified?' <span class="text-zinc-400">(Verified)</span>':''}`).join('')
      : `<li class="list-none text-zinc-500">No record holders yet.</li>`;

    const youtubeThumbnail = level.youtube
      ? `<a href="https://www.youtube.com/watch?v=${encodeURIComponent(level.youtube)}" target="_blank">
           <img src="https://img.youtube.com/vi/${encodeURIComponent(level.youtube)}/hqdefault.jpg"
                alt="${escapeHtml(level.title)}" class="w-32 h-18 rounded-lg hover:scale-105 transition-transform object-cover"/>
         </a>` : '';

    const editButtons = isAdmin
      ? `<button class="editBtn ml-2 px-2 py-1 bg-green-600 text-white rounded hover:bg-green-500 text-sm">Edit</button>
         <button class="deleteBtn ml-2 px-2 py-1 bg-red-600 text-white rounded hover:bg-red-500 text-sm">Delete</button>` : '';

    const section = document.createElement('section');
    section.className='bg-zinc-800 p-4 rounded-2xl shadow-lg hover:bg-zinc-700 transition';
    section.innerHTML = `
      <div class="flex items-start">
        ${youtubeThumbnail}
        <div class="flex-1 ml-3">
          <div class="flex items-center justify-between">
            <h2 class="text-2xl font-bold text-zinc-100">#${level.rank} - ${escapeHtml(level.title)}</h2>
            <div class="flex items-center">
              <span class="text-sm text-zinc-400">by ${escapeHtml(level.creator||'-')}</span>
              ${editButtons}
            </div>
          </div>
          <div class="mt-2 border-t border-zinc-700 pt-2 record-holders" style="display:none;">
            <p class="text-sm text-zinc-100 mb-1">Record Holders:</p>
            <ul class="text-sm space-y-1 text-zinc-100">${holdersHTML}</ul>
          </div>
        </div>
      </div>
    `;
    container.appendChild(section);

    section.addEventListener('click',(e)=>{
      if(!e.target.closest('a')){
        const holdersDiv = section.querySelector('.record-holders');
        holdersDiv.style.display = holdersDiv.style.display==='none'?'block':'none';
      }
    });

    if(isAdmin){
      section.querySelector('.editBtn').addEventListener('click',(e)=>{
        e.stopPropagation();
        editingIndex = index;
        openEditModal(level);
      });
      section.querySelector('.deleteBtn').addEventListener('click',async (e)=>{
        e.stopPropagation();
        if(await confirmPopup(`Delete level #${level.rank} - "${level.title}"?`)){
          await fetch(`/api/levels/${level.rank}`, { method: "DELETE" });
          fetchLevels();
        }
      });
    }
  });

  if(isAdmin){
    const btn = document.createElement('button');
    btn.textContent='Create Level';
    btn.className='px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-500 text-sm';
    btn.onclick=async()=>{
      const newRank = levels.length + 1;
      const newLevel = { rank:newRank, title:"New Level", creator:"", youtube:"", recordHolders:[] };
      await fetch(API, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newLevel) });
      fetchLevels();
      openEditModal(newLevel);
    };
    container.appendChild(btn);
  }
}

/* ---------- Popups ---------- */
function confirmPopup(message){
  return new Promise((resolve)=>{
    const popup = document.createElement('div');
    popup.className='fixed inset-0 bg-black/60 flex items-center justify-center';
    popup.innerHTML=`
      <div class="bg-zinc-800 p-6 rounded-2xl text-center max-w-sm">
        <p class="mb-4">${escapeHtml(message)}</p>
        <div class="flex justify-center gap-3">
          <button id="confirmYes" class="px-3 py-1 bg-red-600 rounded text-white">Yes</button>
          <button id="confirmNo" class="px-3 py-1 bg-zinc-600 rounded text-zinc-100">No</button>
        </div>
      </div>`;
    document.body.appendChild(popup);
    popup.querySelector('#confirmYes').onclick=()=>{popup.remove();resolve(true);}
    popup.querySelector('#confirmNo').onclick=()=>{popup.remove();resolve(false);}
  });
}

/* ---------- Edit Modal ---------- */
const editModal = document.getElementById('editModal');
const editForm = document.getElementById('editForm');
document.getElementById('cancelEdit').onclick=()=>editModal.classList.add('hidden');

function openEditModal(level){
  document.getElementById('editRank').value=level.rank;
  document.getElementById('editTitle').value=level.title;
  document.getElementById('editCreator').value=level.creator;
  document.getElementById('editYoutube').value=level.youtube||'';
  document.getElementById('editRecords').value=level.recordHolders.map(r=>`${r.name}-${r.percent}-${r.verified}`).join(',');
  editModal.classList.remove('hidden');
}

editForm.addEventListener('submit',async(e)=>{
  e.preventDefault();
  const newRank = parseInt(document.getElementById('editRank').value);
  const updated = {
    rank: newRank,
    title: document.getElementById('editTitle').value,
    creator: document.getElementById('editCreator').value,
    youtube: document.getElementById('editYoutube').value,
    recordHolders: document.getElementById('editRecords').value.split(',')
      .filter(Boolean)
      .map(s=>{
        const parts=s.split('-');
        return { name:parts[0].trim(), percent:parts[1]?.trim()||'0%', verified:parts[2]?.trim().toLowerCase()==='true' };
      })
  };
  await fetch(`/api/levels/${newRank}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(updated) });
  editModal.classList.add('hidden');
  fetchLevels();
});

/* ---------- Login ---------- */
const loginModal=document.getElementById('loginModal');
document.getElementById('loginBtn').onclick=()=>loginModal.classList.remove('hidden');
document.getElementById('cancelLogin').onclick=()=>loginModal.classList.add('hidden');
document.getElementById('confirmLogin').onclick=()=>{
  const u=document.getElementById('username').value;
  const p=document.getElementById('password').value;
  if(u==='admin' && p==='1234'){
    isAdmin=true;
    loginModal.classList.add('hidden');
    fetchLevels();
  } else alert("Invalid credentials");
};

/* ---------- Init ---------- */
fetchLevels();
</script>
</body>
</html>
